public with sharing class SHF_Leegality_Service {
    SHF_HTTPCalloutService service;

    
    public static void sendNotification(Id recordId, Set<String> userIds, String notificationTitle, String notificationBody) {
        try{
            CustomNotificationType notificationType  = [SELECT Id FROM CustomNotificationType WHERE DeveloperName = 'Send_Notification_To_User' LIMIT 1];
            Messaging.CustomNotification notification = new Messaging.CustomNotification();
            notification.setTitle(notificationTitle);
            notification.setBody(notificationBody);
            notification.setNotificationTypeId(notificationType .Id);
            notification.setTargetId(recordId);
            notification.send(userIds);
            system.debug('send notification success');
        }catch(Exception e){
            system.debug('send notification --> '+e.getMessage() + ' at line ' + e.getLineNumber());  
        }
    }
    
    @AuraEnabled
    public static Boolean legalityApiCall(String loanApplicationId) {  
        Application__c application = [SELECT Id, Name, Sanction_Amount__c,Owner__c,OwnerId,Owner.Name, Sanction_Date__c, Loan_Product__c, Tenure__c, Rate_of_Interest__c, EMI__c, Sub_Product__c, Negotiation_Rate_of_Interest_ROI__c, Negotiate_Sanctioned_Loan_Amount__c, Negotiate_Tenure__c, Product__r.Product_Type__c, Recommended_Loan_Amount__c, Revised_Rate__c, APR__c,Branch__c,Branch__r.City__c, Branch__r.Name, Branch__r.State__c,Branch__r.City__r.Name, Branch__r.City__r.City_Code__c,E_Sign_Success__c,E_Sign_Executed__c  FROM Application__c WHERE Id =: loanApplicationId];
        sendNotification(application.Id, new Set<String>{application.OwnerId}, 'Success', 'The documents are successfully sent to the customer for E-sign' );
        legalityApiCallFuture(JSON.serialize(application));
        return true;
    }
    
    // Future method to run async callout
    @future(callout = true)
    public static void legalityApiCallFuture(String applicationJson) {
        Application__c application = (Application__c) JSON.deserialize(applicationJson, Application__c.class);
        legalityApiCallService(application);
    }
    
    public static void legalityApiCallService (Application__c application){
        try{
            SHF_Leegality_Service leegalityVerification = new SHF_Leegality_Service();
            leegalityVerification.service = new SHF_HTTPCalloutService('Leegality_Api');
            leegalityVerification.service.setRequestTimeout(90000);
            leegalityVerification.service.setRequestBody(createRequest(application));
            try{
                HttpResponse response;
                if (leegalityVerification.service.getIsActive()) {
                    response = leegalityVerification.service.sendRequest();
                } else {
                    response = new HttpResponse();
                    response.setBody(leegalityVerification.service.getmockRespnse());
                    response.setStatusCode(200);
                }
                application.E_Sign_Executed__c = true;
                system.debug('response.getStatusCode() --> '+ response.getStatusCode());
                if (response.getStatusCode() == 200) {
                    Map<String, Object> responseMap = (Map<String, Object>) JSON.deserializeUntyped(response.getBody());
                    Integer status = (Integer) responseMap.get('status');
                    system.debug('status --> '+ status);
                    if (status == 1) {
                        application.E_Sign_Success__c = true;
                        sendNotification(application.Id, new Set<String>{application.OwnerId}, 'E-Sign Success', 'The response from Leegality has been received. Please check the signed documents in the Customer Documents tab');
                    }else{
                        sendNotification(application.Id, new Set<String>{application.OwnerId}, 'E-Sign Failed', 'Unable to receive the response from Leegality. Kindly take a manual signature from the customer');
                    }
                }else {
                    sendNotification(application.Id, new Set<String>{application.OwnerId}, 'E-Sign Failed', 'Unable to receive the response from Leegality. Kindly take a manual signature from the customer');
                }
            } catch (System.CalloutException e){
                System.debug('api response --> '+ e.getMessage() +' line no. --> '+ e.getLineNumber());
                if (e.getMessage().contains('Read timed out')) {
                    System.debug('FAILURE: Response not received within 90 seconds.');
                    application.E_Sign_Executed__c = true;
                    sendNotification(application.Id, new Set<String>{application.OwnerId}, 'E-Sign Failed', 'Unable to receive the response from Leegality. Kindly take a manual signature from the customer');
                }else{
                    application.E_Sign_Executed__c = false;
                    System.debug('FAILURE: API hitting failed');
                } 
            } finally {
                Update application;
                system.debug('application --> '+ application);
                system.debug('finally');
            }
        } catch(Exception e){
            system.debug(e.getMessage() + ' at line ' + e.getLineNumber());
        }
    }
    
    public static String createRequest(Application__c application){
        RequestWrapper request = new RequestWrapper();
        List<String> base64 = new List<String>();
        Blob pdfBlob;
        // --------------- Sanction Letter -----------//
        PageReference prSanction = new PageReference('/apex/' + 'SHF_Sanction_Letter');
        prSanction.getParameters().put('id', application.Id);
        pdfBlob = prSanction.getContentAsPDF();
        base64.add(EncodingUtil.base64Encode(pdfBlob));
        
        // --------------- Tentative Repayment Schedule -----------//
        /* PageReference prTentative = new PageReference('/apex/' + 'SHF_Tentative_Repayment_Schedule');
prTentative.getParameters().put('id', application.Id);
pdfBlob = prTentative.getContentAsPDF();
base64.add(EncodingUtil.base64Encode(pdfBlob));*/
        // --------------- LAF -----------//
        PageReference prLaf = new PageReference('/apex/' + 'SHF_LAF_Form');
        prLaf.getParameters().put('id', application.Id);
        pdfBlob = prLaf.getContentAsPDF();
        base64.add(EncodingUtil.base64Encode(pdfBlob));
        
        request.additionalFiles = base64;
        
        File file = new File();
        file.name = '';
        List<Fields> fields = new List<Fields>();
        List<Invitees> invitees = new List<Invitees>();
        neslData neslData = new neslData();
        Map<String, String> documentDetail = new Map<String, String>();
        List<Map<String, String>> participants = new List<Map<String, String>>();
        List<Map<String, String>> stampData = new List<Map<String, String>>();
        List<Map<String, String>> neslParties = new List<Map<String, String>>();
        List<Map<String, String>> neslSecurities = new List<Map<String, String>>();
        if(application != null){
            request.irn = application.Name;
            
            documentDetail.put('loanNumber', application.Name ?? '');
            documentDetail.put('sanctionNumber', application.Name ?? '');
            documentDetail.put('registrationType', 'INDIVIDUAL_LOAN');
            documentDetail.put('state', application.Branch__r.State__c ?? '');
            documentDetail.put('branchName', application.Branch__r.Name ?? '');
            documentDetail.put('branchAddress', '');
            Date sanctionDate = application.Sanction_Date__c;
            documentDetail.put('dateOfSanction', sanctionDate != null ? DateTime.newInstance(sanctionDate.year(), sanctionDate.month(), sanctionDate.day()).format('yyyy-MM-dd') : '');
            documentDetail.put('emiAmount', application.EMI__c != null ? String.valueOf(application.EMI__c) : '');
            documentDetail.put('rateOfInterest', application.Revised_Rate__c != null ? String.valueOf(application.Revised_Rate__c) : '');
            documentDetail.put('sanctionAmount', application.Sanction_Amount__c != null ? String.valueOf(application.Sanction_Amount__c) : '');
            documentDetail.put('tenure', application.Tenure__c != null ? String.valueOf(application.Tenure__c) : '');
            documentDetail.put('typeOfDebt', 'Financial');
            documentDetail.put('accountClosedFlag', 'No');
            documentDetail.put('fundType', 'Funded');
            documentDetail.put('sanctionCurrency', 'INR');
            documentDetail.put('creditSubtype', 'CREDIT_FACILITY');
            documentDetail.put('facilityName', application.Loan_Product__c ?? '');
            documentDetail.put('amountOverdue', '0');
            documentDetail.put('otherChargeAmount', '0');
            documentDetail.put('debtStartDate', String.valueOf(Date.today()));
            documentDetail.put('interestAmount', '0');
            documentDetail.put('oldDebtRefNo', 'NA');
            documentDetail.put('principalOutstanding', '0');
            documentDetail.put('loanRemark', 'NA');
            documentDetail.put('totalOutstandingAmount', '0');
            documentDetail.put('creditorBusinessUnit', 'NA');
            documentDetail.put('drawingPower', '0');
            documentDetail.put('daysPastDue', '0');
            documentDetail.put('docRefNo', 'NA');
            documentDetail.put('event', 'NA');
            documentDetail.put('expiryDateEbg', 'NA');
            documentDetail.put('currencyOfDebt', 'INR');
            documentDetail.put('claimExpiryDate', 'NA');
            documentDetail.put('contractRefNo', 'NA');
            documentDetail.put('vendorCode', 'NA');
            documentDetail.put('portalID', 'NA');
            neslData.documentDetail = documentDetail;
            
            List<Loan_Applicant__c> applicants = [SELECT Id, Name, Applicant_Type__c, Account_Name__c,Constitution__c, Salutation__c,Registration_No__c, Description__c , Email__c, Mobile_Number__c, Alternate_Mobile_Number__c, Date_of_Birth__c,Aadhar_Number__c,Pan_Number__c, Customer_Type__c,Gender__c, Address__r.Address_Line_1__c, Address__r.Address_Line_2__c, Address__r.Address_Line_3__c, Address__r.Pincode__r.City_Master__r.Name, Address__r.Pincode__r.Name FROM Loan_Applicant__c WHERE Application__c = :application.Id];
            Set<Id> applicantIds = new Map<Id, Loan_Applicant__c>(applicants).keySet();
            List<Address__c> addresses = new SHF_AddressesSelector().fetchAddressesForLeegality(applicantIds);
            Map<Id, List<Address__c>> applicantAddresses = new Map<Id, List<Address__c>>();
            if(!addresses.isEmpty()){
                for(Address__c address : addresses){
                    if(address.Loan_Applicant__c != null){
                        if(applicantAddresses.containsKey(address.Loan_Applicant__c)){
                            applicantAddresses.get(address.Loan_Applicant__c).add(address);
                        }else{
                            applicantAddresses.put(address.Loan_Applicant__c, new List<Address__c>{address});
                        }
                    }
                }
            }
            
            if(!applicants.isEmpty()){
                Loan_Applicant__c primaryApplicant;
                List<Loan_Applicant__c> coApplicants = new List<Loan_Applicant__c>();
                List<Loan_Applicant__c> guarantors = new List<Loan_Applicant__c>();
                for (Loan_Applicant__c app : applicants) {
                    if (app.Applicant_Type__c == 'Primary Applicant') {
                        primaryApplicant = app;
                    } else if (app.Applicant_Type__c == 'Co-Applicant') {
                        coApplicants.add(app);
                    } else if (app.Applicant_Type__c == 'Guarantor') {
                        guarantors.add(app);
                    }
                }
                
                Address__c primaryCurrentAddress;
                if (primaryApplicant != null && applicantAddresses.containsKey(primaryApplicant.Id)) {
                    for (Address__c addr : applicantAddresses.get(primaryApplicant.Id)) {
                        if (addr.Address_Type__c == 'Current Address' && addr.Is_Communication_Address__c == true) {
                            primaryCurrentAddress = addr;
                        }
                    }
                }
                
                if (primaryApplicant != null) {
                    String formattedDate = DateTime.now().format('dd/MM/yyyy');
                    DateTime nowDT = DateTime.now();
                    
                    Integer dayNum = nowDT.day();
                    String daySuffix;
                    if (dayNum == 1 || dayNum == 21 || dayNum == 31) {
                        daySuffix = 'st';
                    } else if (dayNum == 2 || dayNum == 22) {
                        daySuffix = 'nd';
                    } else if (dayNum == 3 || dayNum == 23) {
                        daySuffix = 'rd';
                    } else {
                        daySuffix = 'th';
                    }
                    
                    String dayWithSuffix = dayNum + daySuffix;  // 29th
                    String monthName = nowDT.format('MMMM');// February
                    String yearShort = nowDT.format('yy');  // 24
                    String loanAmountInWords = application.Sanction_Amount__c != null ? String.valueOf(application.Sanction_Amount__c) : '';
                    
                    List<Map<String, Object>> fieldConfigs = new List<Map<String, Object>>{
                        new Map<String, Object>{
                            'id' => '1702208952696',
                                'name' => 'Authorised Signatory Name on behalf of Shubham Finance',
                                'type' => 'text',
                                'value' => 'Shubham Housing Development Finance Compnay Limited',
                                'required' => false
                                },
                                    new Map<String, Object>{
                                        'id' => '1702209131361',
                                            'name' => 'Borrower Name',
                                            'type' => 'text',
                                            'value' => primaryApplicant != null ? primaryApplicant.Account_Name__c : '',
                                                'required' => true
                                                },
                                                    new Map<String, Object>{
                                                        'id' => '1702209192965',
                                                            'name' => 'Borrower Address',
                                                            'type' => 'text',
                                                            'value' => primaryCurrentAddress != null ? primaryCurrentAddress.Address_Line_1__c : '',
                                                                'required' => false
                                                                },
                                                                    new Map<String, Object>{
                                                                        'id' => '1702211436019',
                                                                            'name' => 'Title for Borrower Name',
                                                                            'type' => 'radio',
                                                                            'value' => primaryApplicant != null ? primaryApplicant.Salutation__c : '',
                                                                                'checked' => true,
                                                                                'required' => false
                                                                                },
                                                                                    new Map<String, Object>{
                                                                                        'id' => '1702211446710',
                                                                                            'name' => 'Title for Borrower Name',
                                                                                            'type' => 'radio',
                                                                                            'value' => primaryApplicant != null ? primaryApplicant.Salutation__c : '',
                                                                                                'checked' => false,
                                                                                                'required' => false
                                                                                                },
                                                                                                    new Map<String, Object>{
                                                                                                        'id' => '1702209439389',
                                                                                                            'name' => 'Authorised Signatory Name on behalf of Borrower',
                                                                                                            'type' => 'text',
                                                                                                            'value' => primaryApplicant != null ? primaryApplicant.Account_Name__c : '',
                                                                                                                'required' => false
                                                                                                                },
                                                                                                                    new Map<String, Object>{
                                                                                                                        'id' => '1702209818056',
                                                                                                                            'name' => 'Title for Co-Borrower 1 Name',
                                                                                                                            'type' => 'radio',
                                                                                                                            'value' => !coApplicants.isEmpty() ? coApplicants[0].Salutation__c : (!guarantors.isEmpty() ? guarantors[0].Salutation__c : ''),
                                                                                                                                'checked' => true,
                                                                                                                                'required' => false
                                                                                                                                },
                                                                                                                                    new Map<String, Object>{
                                                                                                                                        'id' => '1702209836524',
                                                                                                                                            'name' => 'Title for Co-Borrower 1 Name',
                                                                                                                                            'type' => 'radio',
                                                                                                                                            'value' => !coApplicants.isEmpty() ? coApplicants[0].Salutation__c : (!guarantors.isEmpty() ? guarantors[0].Salutation__c : ''),
                                                                                                                                                'checked' => false,
                                                                                                                                                'required' => false
                                                                                                                                                },
                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                        'id' => '1702213589429',
                                                                                                                                                            'name' => 'Co-Borrower 1 Name',
                                                                                                                                                            'type' => 'text',
                                                                                                                                                            'value' => !coApplicants.isEmpty() ? coApplicants[0].Account_Name__c : (!guarantors.isEmpty() ? guarantors[0].Account_Name__c : ''),
                                                                                                                                                                'required' => false
                                                                                                                                                                },
                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                        'id' => '1702209854836',
                                                                                                                                                                            'name' => 'Title for Co-Borrower 2 Name',
                                                                                                                                                                            'type' => 'radio',
                                                                                                                                                                            'value' => coApplicants.size() > 1 ? coApplicants[1].Salutation__c : (guarantors.size() > 1 ? guarantors[1].Salutation__c : ''),
                                                                                                                                                                                'checked' => true,
                                                                                                                                                                                'required' => false
                                                                                                                                                                                },
                                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                                        'id' => '1702209866025',
                                                                                                                                                                                            'name' => 'Title for Co-Borrower 2 Name',
                                                                                                                                                                                            'type' => 'radio',
                                                                                                                                                                                            'value' => coApplicants.size() > 1 ? coApplicants[1].Salutation__c : (guarantors.size() > 1 ? guarantors[1].Salutation__c : ''),
                                                                                                                                                                                                'checked' => false,
                                                                                                                                                                                                'required' => false
                                                                                                                                                                                                },
                                                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                                                        'id' => '1702213589432',
                                                                                                                                                                                                            'name' => 'Co-Borrower 2 Name',
                                                                                                                                                                                                            'type' => 'text',
                                                                                                                                                                                                            'value' => coApplicants.size() > 1 ? coApplicants[1].Account_Name__c : (guarantors.size() > 1 ? guarantors[1].Account_Name__c : ''),
                                                                                                                                                                                                                'required' => false
                                                                                                                                                                                                                },
                                                                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                                                                        'id' => '1702209883198',
                                                                                                                                                                                                                            'name' => 'Title for Co-Borrower 3 Name',
                                                                                                                                                                                                                            'type' => 'radio',
                                                                                                                                                                                                                            'value' => coApplicants.size() > 2 ? coApplicants[2].Salutation__c : (guarantors.size() > 2 ? guarantors[2].Salutation__c : ''),
                                                                                                                                                                                                                                'checked' => false,
                                                                                                                                                                                                                                'required' => false
                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                                                                                        'id' => '1702209894382',
                                                                                                                                                                                                                                            'name' => 'Title for Co-Borrower 3 Name',
                                                                                                                                                                                                                                            'type' => 'radio',
                                                                                                                                                                                                                                            'value' => coApplicants.size() > 2 ? coApplicants[2].Salutation__c : (guarantors.size() > 2 ? guarantors[2].Salutation__c : ''),
                                                                                                                                                                                                                                                'checked' => false,
                                                                                                                                                                                                                                                'required' => false
                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                                                                                                        'id' => '1702213589435',
                                                                                                                                                                                                                                                            'name' => 'Co-Borrower 3 Name',
                                                                                                                                                                                                                                                            'type' => coApplicants.size() > 2 ? coApplicants[2].Account_Name__c : (guarantors.size() > 2 ? guarantors[2].Account_Name__c : ''),
                                                                                                                                                                                                                                                                'value' => false,
                                                                                                                                                                                                                                                                'required' => false
                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                                                                                                                        'id' => '1702209758344',
                                                                                                                                                                                                                                                                            'name' => 'Title for Witness Name',
                                                                                                                                                                                                                                                                            'type' => 'radio',
                                                                                                                                                                                                                                                                            'value' => 'Mr.',  //Witness Details
                                                                                                                                                                                                                                                                            'checked' => true,
                                                                                                                                                                                                                                                                            'required' => false
                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                new Map<String, Object>{
                                                                                                                                                                                                                                                                                    'id' => '1702209769648',
                                                                                                                                                                                                                                                                                        'name' => 'Title for Witness Name',
                                                                                                                                                                                                                                                                                        'type' => 'radio',
                                                                                                                                                                                                                                                                                        'value' => 'Ms.', //Witness Details
                                                                                                                                                                                                                                                                                        'checked' => false,
                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                'id' => '1702213589438',
                                                                                                                                                                                                                                                                                                    'name' => 'Witness Name',
                                                                                                                                                                                                                                                                                                    'type' => 'text', //witness details
                                                                                                                                                                                                                                                                                                    'value' => false,
                                                                                                                                                                                                                                                                                                    'required' => false
                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                        new Map<String, Object>{
                                                                                                                                                                                                                                                                                                            'id' => '1702210652317',
                                                                                                                                                                                                                                                                                                                'name' => 'Borrower Name (DPN)',
                                                                                                                                                                                                                                                                                                                'type' => 'text',
                                                                                                                                                                                                                                                                                                                'value' => primaryApplicant != null ? primaryApplicant.Account_Name__c : '',
                                                                                                                                                                                                                                                                                                                    'required' => false
                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                        new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                            'id' => '1702210719791',
                                                                                                                                                                                                                                                                                                                                'name' => 'Loan Amount in Fogures (DPN)',
                                                                                                                                                                                                                                                                                                                                'type' => 'text',
                                                                                                                                                                                                                                                                                                                                'value' => application.Sanction_Amount__c != null ? String.valueOf(application.Sanction_Amount__c) : '', // sanctioned Nagotiation value
                                                                                                                                                                                                                                                                                                                                    'required' => false
                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                        new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                            'id' => '1702213589441',
                                                                                                                                                                                                                                                                                                                                                'name' => 'Loan Amount in Words (DPN)',
                                                                                                                                                                                                                                                                                                                                                'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                'value' => loanAmountInWords,  // sanctioned Nagotiation value
                                                                                                                                                                                                                                                                                                                                                'required' => false
                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                        'id' => '1702210804113',
                                                                                                                                                                                                                                                                                                                                                            'name' => 'Interest Rate (DPN)',
                                                                                                                                                                                                                                                                                                                                                            'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                            'value' => application.Revised_Rate__c != null ? String.valueOf(application.Revised_Rate__c) : '',
                                                                                                                                                                                                                                                                                                                                                                'required' => false
                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                        'id' => '1702210586587',
                                                                                                                                                                                                                                                                                                                                                                            'name' => 'Place (DPN)',
                                                                                                                                                                                                                                                                                                                                                                            'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                            'value' => application.Branch__c != null ? application.Branch__r.City__r.Name : '',
                                                                                                                                                                                                                                                                                                                                                                                'required' => false
                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                   /* new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                        'id' => '1702213589444',
                                                                                                                                                                                                                                                                                                                                                                                            'name' => 'Date (DPN)',
                                                                                                                                                                                                                                                                                                                                                                                            'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                            'value' => formattedDate,
                                                                                                                                                                                                                                                                                                                                                                                            'required' => false
                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                    'id' => '1702211032374',
                                                                                                                                                                                                                                                                                                                                                                                                        'name' => 'Demand Promissory Note Dated',
                                                                                                                                                                                                                                                                                                                                                                                                        'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                        'value' => formattedDate,
                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                        },*/
                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589446',
                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Loan Amount in Figures (Letter of Continuity)',
                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => loanAmountInWords,  // sanctioned Nagotiation value
                                                                                                                                                                                                                                                                                                                                                                                                                    'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                                                                                        new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                            'id' => '1702213589447',
                                                                                                                                                                                                                                                                                                                                                                                                                                'name' => 'Loan Amount in Words (Letter of Continuity)',
                                                                                                                                                                                                                                                                                                                                                                                                                                'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                'value' => loanAmountInWords,  // sanctioned Nagotiation value
                                                                                                                                                                                                                                                                                                                                                                                                                                'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                        'id' => '1702213589448',
                                                                                                                                                                                                                                                                                                                                                                                                                                            'name' => 'Place (Letter of Continuity)',
                                                                                                                                                                                                                                                                                                                                                                                                                                            'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                            'value' => application.Branch__c != null ? application.Branch__r.City__r.Name : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                        'id' => '1702213589449',
                                                                                                                                                                                                                                                                                                                                                                                                                                                            'name' => 'Date (Letter of Continuity)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                            'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                            'value' => dayWithSuffix,
                                                                                                                                                                                                                                                                                                                                                                                                                                                            'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'id' => '1702213589450',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'name' => 'Day (Letter of Continuity)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'value' => monthName,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589451',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Year (Letter of Continuity)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => yearShort,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'id' => '1702211934599',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'name' => 'Place (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'value' => application.Branch__c != null ? application.Branch__r.City__r.Name : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'id' => '1702213589453',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'name' => 'Date (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'value' => dayWithSuffix,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'id' => '1702213589454',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'name' => 'Day (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'value' => monthName,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'id' => '1702213589455',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'name' => 'Year (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'value' => yearShort,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589456',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Borrower Name (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => primaryApplicant != null ? primaryApplicant.Account_Name__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589457',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Borrower Address (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => primaryCurrentAddress != null ? primaryCurrentAddress.Address_Line_1__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589458',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Title for Co-Borrower 1 Name (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'radio',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => coApplicants != null ? coApplicants[0].Salutation__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'checked' => true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589459',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Title for Co-Borrower 1 Name (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'radio',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => coApplicants != null ? coApplicants[0].Salutation__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'checked' => false,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589460',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Co-Borrower 1 Name (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => coApplicants != null ? coApplicants[0].Account_Name__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589461',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Title for Co-Borrower 2 Name (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'radio',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => coApplicants != null ? coApplicants[0].Salutation__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'checked' => true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589462',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Title for Co-Borrower 2 Name (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'radio',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => coApplicants != null ? coApplicants[0].Salutation__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'checked' => false,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589463',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Co-Borrower 2 Name (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => coApplicants != null ? coApplicants[0].Account_Name__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589464',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Title for Co-Borrower 3 Name (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'radio',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => coApplicants != null ? coApplicants[0].Salutation__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'checked' => false,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589465',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Title for Co-Borrower 3 Name (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'radio',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => coApplicants != null ? coApplicants[0].Salutation__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'checked' => false,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589466',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Co-Borrower 3 Name (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => coApplicants != null ? coApplicants[0].Account_Name__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589467',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Title for Witness Name (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'radio',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => coApplicants != null ? coApplicants[0].Salutation__c : 'Mr.', //Witness Details
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'checked' => true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589469',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Title for Witness Name (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'radio',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => coApplicants != null ? coApplicants[0].Salutation__c : 'Mr.',  //Witness Details
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'checked' => false,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702213589470',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Witness Name (Power of Attorney)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => coApplicants != null ? coApplicants[0].Name : '',  //Witness Details
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702212879864',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Property Description (Schedule)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => coApplicants != null ? coApplicants[0].Description__c : '', //Collateral address
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1702214913800',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Borrower Name (Memorandum of Entry)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => primaryApplicant != null ? primaryApplicant.Account_Name__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1717094311160',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'acting through Proprietor/director/Partner',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => primaryApplicant != null ? primaryApplicant.Constitution__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           /* new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id' => '1712832519855',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'name' => 'Loan Agreement/ Deposit Date (Memorandum of Entry)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'value' => formattedDate,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    },*/
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'id' => '1712832519856',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'name' => 'Place (Memorandum of Entry)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'value' => application.Branch__r != null ? application.Branch__r.Name : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'id' => '1712832519857',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'name' => 'Loan Amt (Memorandum of Entry)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'value' => application.Sanction_Amount__c != null ? String.valueOf(application.Sanction_Amount__c) : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'id' => '1712831279043',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'name' => 'Loan Account/Application No. (Memorandum of Entry)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'value' => application.Name != null ? application.Name : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'id' => '1712832519859',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'name' => 'Shubhams office where deposited (Memorandum of Entry)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'value' => 'Gurgaon',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'id' => '1712832519860',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'name' => 'Shubhams representative (Memorandum of Entry)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'value' => application.Owner != null ? application.Owner.Name : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'id' => '1712831919185',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'name' => 'Property Bearing Number (Memorandum of Entry)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'value' => primaryApplicant != null ? primaryApplicant.Registration_No__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'id' => '1712831930752',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'name' => 'Property Area (Memorandum of Entry)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'value'=> '1665',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'id' => '1712832519863',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'name' => 'Property Location (Memorandum of Entry)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'value' => primaryApplicant != null ? primaryApplicant.Address__c : '', //Collatrel address
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'id' => '1702219366151',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'name' => 'Title for Borrower (Acknowledgement)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'type' => 'radio',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'value' => primaryApplicant != null ? primaryApplicant.Salutation__c : '', // e.g., 'Shri', 'Smt.', 'Kum.'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'checked' => true, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'id' => '1702219375976',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'name' => 'Title for Borrower (Acknowledgement)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'type' => 'radio',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'value' => primaryApplicant != null ? primaryApplicant.Salutation__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'checked' => false,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'id' => '1702219382724',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'name' => 'Title for Borrower (Acknowledgement)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'type' => 'radio',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'value' => primaryApplicant != null ? primaryApplicant.Salutation__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'checked' => false,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                new Map<String, Object>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'id' => '1702219335653',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'name' => 'Borrower Name (Acknowledgement)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'type' => 'text',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'value' => primaryApplicant != null ? primaryApplicant.Account_Name__c : '',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'required' => false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                        
                    };
                        
                        for (Map<String, Object> cfg : fieldConfigs) {
                            Fields f = new Fields();
                            f.id = (String) cfg.get('id');
                            f.name = (String) cfg.get('name');
                            f.type = (String) cfg.get('type');
                            f.value = String.valueOf(cfg.get('value'));
                            f.required = (Boolean) cfg.get('required');
                            f.checked = (Boolean) cfg.get('checked');
                            fields.add(f);
                        }
                }
                
                
                
                /*  Fields field = new Fields();
field.id = '1702208952696';
field.name = 'Authorised Signatory Name on behalf of Shubham Finance';
field.type = 'text';
field.value = 'Shubham Housing Development Finance Compnay Limited';
field.required = false;
fields.add(field);

for(Loan_Applicant__c app : applicants) {
if(app.Applicant_Type__c == 'Primary Applicant') {
Fields borrowerField = new Fields();
borrowerField.id = '1702209131361'; // Your provided ID
borrowerField.name = 'Borrower Name';
borrowerField.type = 'text';
borrowerField.value = app.Name;
borrowerField.required = true;
fields.add(borrowerField);
}
}*/
                
                for(Integer i=0; i<applicants.size(); i++){
                    
                    Address__c currentCommAddress;
                    String city = '';
                    String pincode = '';
                    if(applicantAddresses.containsKey(applicants[i].Id)){
                        for (Address__c addr : applicantAddresses.get(applicants[i].Id)) {
                            if (addr.Mailing_Address__c == 'Current Address' && addr.Is_Communication_Address__c == true ) {
                                currentCommAddress = addr;
                                city = addr.City__c ?? '';
                                pincode = addr.Pincode__r.Name ?? '';
                                break;
                            }
                        }
                    }
                    
                    Invitees invite = new Invitees();
                    invite.name = applicants[i].Name ?? '';
                    invite.email = applicants[i].Email__c ?? '';
                    invite.phone = applicants[i].Mobile_Number__c ?? '';
                    
                    Map<String, String> participant = new Map<String, String>();
                    participant.put('fullName', applicants[i].Name ?? '');
                    participant.put('contactPersonName', applicants[i].Name ?? '');
                    participant.put('contactRelation', 'DEBTOR');
                    participant.put('emailId', applicants[i].Email__c ?? '');
                    participant.put('mobileNumber', applicants[i].Mobile_Number__c ?? '');
                    Date dob = applicants[i].Date_of_Birth__c;
                    participant.put('dob', dob != null ? DateTime.newInstance(dob.year(), dob.month(), dob.day()).format('yyyy-MM-dd') : '');
                    participant.put('legalConstitution', 'RESIDENT_INDIVIDUAL');
                    participant.put('alternateEmailId', '');
                    participant.put('alternateMobileNumber', applicants[i].Alternate_Mobile_Number__c ?? '');
                    participant.put('officialDocType','PAN_CARD');
                    participant.put('officialDocId', applicants[i].Pan_Number__c ?? '');
                    participant.put('registeredAddress', city);
                    participant.put('registeredPinCode', pincode);
                    participant.put('designation', 'NA');
                    participant.put('communicationAddress', 'NA');
                    participant.put('communicationAddressPinCode', '');
                    participant.put('cin', '');
                    participant.put('kin', '');
                    participant.put('partyType', 'INDIAN_ENTITY');
                    participant.put('isIndividual', '');
                    participant.put('signatoryGender', '');
                    participant.put('businessUnit', '');
                    
                    participants.add(participant);
                    
                    String verifyTitle = applicants[i].Aadhar_Number__c != null ? applicants[i].Aadhar_Number__c.subString(8) : '';
                    String verifyYob = applicants[i].Date_of_Birth__c != null ? String.valueOf(applicants[i].Date_of_Birth__c.year()) : '';
                    String verifyGender = '';
                    if(applicants[i].Gender__c != null){
                        if(applicants[i].Gender__c == 'Male'){
                            verifyGender = 'M';
                        }else if(applicants[i].Gender__c == 'Female'){
                            verifyGender = 'F';
                        }
                    }
                    if(applicants[i].Applicant_Type__c == 'Primary Applicant'){
                        Map<String, String> stamp = new Map<String, String>();
                        stamp.put('firstParty', 'Shubham Housing Development Finance LTD');
                        stamp.put('secondParty', applicants[i].Name ?? '');
                        stamp.put('stampDutyAmount', '');
                        stamp.put('considerationPrice', application.Sanction_Amount__c != null ? String.valueOf(application.Sanction_Amount__c) : '');
                        stamp.put('descriptionOfDocument', 'Loan Agreement');
                        stamp.put('stampDutyPaidBy', 'Shubham Housing Development Finance LTD');
                        stamp.put('articleCode', '');
                        String firstPartyPin = '';
                        String secondPartyPin = '';
                        if(application.Branch__r.State__c != null){
                            firstPartyPin = application.Branch__r.State__c.toLowerCase() == 'madhya pradesh' ? application.Branch__r.City__r.City_Code__c : application.Branch__r.State__c;
                        }
                        stamp.put('firstPartyPin', firstPartyPin);
                        stamp.put('secondPartyPin', secondPartyPin);
                        stamp.put('firstPartyOVDType', '');
                        stamp.put('firstPartyOVDValue', '');
                        stamp.put('secondPartyOVDType', '');
                        stamp.put('secondPartyOVDValue', '');
                        
                        stampData.add(stamp);
                        
                        NeslConfig neslConfig = new NeslConfig();
                        neslConfig.verifyTitle =verifyTitle;
                        neslConfig.verifyYob =verifyYob;
                        neslConfig.verifyGender = verifyGender;
                        invite.neslConfig = neslConfig;
                    }else {
                        AadhaarConfig aadhaarConfig = new AadhaarConfig();
                        aadhaarConfig.verifyTitle = verifyTitle;
                        aadhaarConfig.verifyYob = verifyYob;
                        aadhaarConfig.verifyGender = verifyGender;
                        invite.aadhaarConfig = aadhaarConfig;
                    }
                    invitees.add(invite);
                }
                
            }
            file.fields = fields;
        }
        neslData.participants = participants;
        neslData.stampData = stampData;
        neslData.neslParties = neslParties;
        neslData.neslSecurities = neslSecurities;
        
        request.profileId = 'rUPrqjM';
        request.file = file;
        request.invitees = invitees;
        request.neslData = neslData;
        system.debug('request --> '+ JSON.serializePretty(request));
        return JSON.serialize(request);
    }
    
    public class RequestWrapper {
        public String profileId;
        public File file;
        public List<Invitees> invitees;
        public neslData neslData;
        public String irn;
        public List<String> additionalFiles;
    }
    
    public class File {
        public String name;
        public List<Fields> fields;
    }
    
    public class Fields {
        public String id;
        public String name;
        public String type;
        public String value;
        public Boolean required;
        public Boolean checked;
    }
    
    public class Invitees {
        public String name;
        public String email;
        public String phone;
        public AadhaarConfig  aadhaarConfig;
        public NeslConfig neslConfig;
    }
    
    public  class AadhaarConfig {
        public String verifyTitle;
        public String verifyYob;
        public String verifyGender;
    }
    
    public class NeslConfig {
        public String verifyTitle;
        public String verifyYob;
        public String verifyGender; 
    }
    
    public class NeslData {
        public Map<String, String> documentDetail;
        public List<Map<String, String>> participants;
        public List<Map<String, String>> neslSecurities;
        public List<Map<String, String>> stampData;
        public List<Map<String, String>> neslParties;
    }
    
}