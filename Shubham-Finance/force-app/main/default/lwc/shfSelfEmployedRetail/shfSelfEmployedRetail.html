<template>
    <lightning-card title="Self Employed Retail Income Program">
        <div class="slds-m-around_medium slds-scrollable_x">
            <table class="slds-table slds-table_bordered slds-table_col-bordered slds-no-row-hover">
                <thead>
                    <tr>
                        <th rowspan="2" class="blue-header">Item</th>
                        <th rowspan="2" class="blue-header">Daily Volume</th>
                        <th colspan="3" class="slds-text-align_center blue-header">Cost</th>
                        <th rowspan="2" class="blue-header">Total Cost/Unit</th>
                        <th rowspan="2" class="blue-header">Sale Value/unit</th>
                        <th rowspan="2" class="blue-header">Saving/unit</th>
                        <th rowspan="2" class="blue-header">Gross Daily Income</th>
                        <th rowspan="2" class="blue-header">Action</th>
                    </tr>
                    <tr>
                        <th class="blue-header">Cost A</th>
                        <th class="blue-header">Cost B</th>
                        <th class="blue-header">Cost C</th>
                    </tr>
                </thead>
                <tbody>
                    <template for:each={tableData} for:item="row">
                        <tr key={row.id}>
                            <template for:each={row.fields} for:item="field">

                                <template if:false={field.isCostParent}>
                                    <td key={field.key}>
                                        <lightning-input
                                            variant="label-hidden"
                                            type={field.type}
                                            formatter={field.formatter}
                                            step="0.01"
                                            value={field.value}
                                            data-row={row.id}
                                            data-order={field.order}
                                            disabled={field.disabled}
                                            
                                            min={field.minValue}
                                            max={field.maxValue}
                                            max-length={field.maxLength}
                                            
                                            message-when-range-underflow={field.minMessage}
                                            message-when-range-overflow={field.maxMessage}
                                            message-when-too-long={field.lenMessage}

                                            message-when-step-mismatch="Please enter a value with up to 2 decimal places (e.g., 90.50)."
                                            
                                            onchange={handleInputChange}>
                                        </lightning-input>
                                    </td>
                                </template>

                            </template>
                            <td class="slds-text-align_center">
                                <lightning-button-icon 
                                    icon-name="utility:delete" 
                                    variant="error" 
                                    alternative-text="Delete Row" 
                                    data-row={row.id}
                                    disabled={isDeleteDisabled}
                                    onclick={handleOpenDeleteModal}>
                                </lightning-button-icon>
                            </td>
                        </tr>
                    </template>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="8" class="slds-text-align_right slds-text-title_bold">Gross Daily Income Total</td>
                        <td class="total-cell">
                            <lightning-input
                                type="number"
                                formatter="currency"
                                step="0.01"
                                variant="label-hidden"
                                disabled
                                value={totals.daily}>
                            </lightning-input>
                        </td>
                        <td></td> 
                    </tr>

                    <tr>
                        <td colspan="8" class="slds-text-align_right slds-text-title_bold">Gross Monthly Income(26 Days)</td>
                        <td class="total-cell">
                            <lightning-input
                                type="number"
                                formatter="currency"
                                step="0.01"
                                variant="label-hidden"
                                disabled
                                value={totals.monthly}>
                            </lightning-input>
                        </td>
                        <td></td> 
                    </tr>

                    <tr>
                        <td colspan="8" class="slds-text-align_right slds-text-title_bold">Less : Expenses(as per expanse schedule)</td>
                        <td class="total-cell" style="padding: 0;">
                             <lightning-input 
                                type="number" 
                                formatter="currency"
                                min="0"
                                max-length="10"

                                message-when-range-underflow="Value must be at least 0"

                                step="0.01"
                                message-when-step-mismatch="Please enter a value with up to 2 decimal places (e.g., 90.50)."
                                variant="label-hidden" 
                                value={totals.expenses} 
                                onchange={handleExpenseChange}
                                class="footer-input">
                            </lightning-input>
                        </td>
                        <td></td> 
                    </tr>

                    <tr>
                        <td colspan="8" class="slds-text-align_right slds-text-title_bold">Net Income (Monthly)</td>
                        <td class="total-cell" style="background-color: #d1ffbd;">
                            <lightning-input
                                type="number"
                                formatter="currency"
                                step="0.01"
                                variant="label-hidden"
                                disabled
                                value={totals.netIncome}>
                            </lightning-input>
                        </td>
                        <td></td> 
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="slds-m-top_medium slds-grid slds-grid_align-center slds-gutters">
            <div class="slds-col">
                <lightning-button label="Add Item Row" icon-name="utility:add" onclick={handleAddRow}></lightning-button>
            </div>
            <div class="slds-col">
                <lightning-button label="Save All Items" variant="brand" onclick={handleSave}></lightning-button>
            </div>
        </div>
    </lightning-card>
    
    <template if:true={isDeleteModalOpen}>
       <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <h2 class="slds-text-heading_medium">Confirm Deletion</h2>
                </header>
                <div class="slds-modal__content slds-p-around_medium">
                    <p>Are you sure you want to delete this row? This action cannot be undone.</p>
                </div>
                <footer class="slds-modal__footer">
                    <lightning-button label="Cancel" onclick={closeModal} class="slds-m-right_x-small"></lightning-button>
                    <lightning-button label="Delete" variant="destructive" onclick={confirmDelete}></lightning-button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>